<template>
    <Popup
        class="component__LoadDialog LoadDialog"
        :value="value"
        :close-on-click-overlay="closeOnClickOverlay"
        @input="onInput"
        @closed="onClosed"
    >
        <img
            v-if="imgIsLoad"
            :src="rectangleImage"
            class="mainImg"
            @click="imgClick"
            @load="imgLoad"
        />
        <div
            v-else
            class="mainDiv flex f-ai-c f-jc-c"
        >
            <Loading
                class="Loading"
                :size="80"
            ></Loading>
        </div>
        <i
            v-if="showClose && isShowClose"
            class="w-iconfont w-icon-fenzux1 close"
            @click="close"
        ></i>
        <slot v-if="imgIsLoad"></slot>
    </Popup>
</template>

<script>
    import Popup from '@wanwu/base-vue-popup';
    import {
        getDownloadImage,
    } from '@wanwu/canvas2image';
    import Loading from '@wanwu/base-vue-loading';
    import {
        ImageUtils,
    } from '@wanwu/base-fn';
    export default {
        name: 'LoadDialog',
        components: {
            Popup,
            Loading,
        },
        props: {
            src: String,
            showClose: Boolean,
            jumpUrl: String,
            value: Boolean,
            closeOnClickOverlay: {
                type: Boolean,
                default: true,
            },
            onImgClick: {
                type: Function,
            },
        },
        data() {
            return {
                imgIsLoad: false,
                isShowClose: false,
            };
        },

        computed: {
            rectangleImage() {
                return this.getRectangleImageWithWidth(this.src, 800);
            },
        },
        created() {
            this.loadImg();
        },
        methods: {
            getRectangleImageWithWidth: ImageUtils.getRectangleImageWithWidth,
            imgLoad() {
                this.isShowClose = true;
            },
            imgClick() {
                this.$emit('imgClick');
                this.onImgClick && this.onImgClick();
                if (this.jumpUrl) {
                    this.$location.push(this.jumpUrl);
                } else if (!this.showClose) {
                    this.close();
                }
            },
            close() {
                this.onInput(false);
            },
            onInput(val) {
                this.$emit('input', val);
            },
            loadImg() {
                getDownloadImage(this.rectangleImage).then((res) => {
                    this.imgIsLoad = true;
                }).catch(err => {
                    this.$logError(err);
                });
            },
            onClosed() {
                this.$emit('closed');
            },
        },
    };
</script>

<style lang='less' scoped>
.component__LoadDialog {
    .mainImg {
        width: 748px;
        display: block;
    }

    .mainDiv {
        width: 748px;
        height: 860px;
    }

    .close {
        color: #fff;
        font-size: 64px;
        position: absolute;
        top: -32px;
        right: 40px;
    }
}
</style>
