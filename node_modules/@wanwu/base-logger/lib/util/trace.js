"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// traceLink 业务追踪相关方法
var config_1 = require("../config");
var hash_1 = require("./hash");
var cross_1 = require("./cross");
var base_fn_1 = require("@wanwu/base-fn");
var traceUtil = {
    // ext数据处理
    parseTraceData: function (data) {
        // app内不处理
        if (base_fn_1.ua.isApp())
            return;
        // 如果追踪动作已发生，进行重置其值
        if (data && data.traceLinkKey) {
            // 获取traceLink
            var traceLink = this.getTraceLink();
            traceLink[data.traceLinkKey] = (base_fn_1.ua.isWechatMiniProgram() ? 'XCX' : 'H5') + "." + hash_1.default.rand(8);
            this.setTraceLink(traceLink);
        }
    },
    // 获取traceLink
    getTraceLink: function () {
        try {
            // 获取顺序 window.name => url => config
            var traceLink = cross_1.default.getWindowNameItem('traceLink');
            if (traceLink)
                return traceLink;
            // url带参数是因为小程序池子不互通
            if (base_fn_1.fn.getQueryString('traceLink')) {
                traceLink = JSON.parse(base_fn_1.fn.getQueryString('traceLink'));
                // 补充到window.name
                cross_1.default.setWindowName({ traceLink: traceLink });
                return traceLink;
            }
            traceLink = config_1.default.traceLink;
            // 初次赋值需要加入url 和 window.name中
            cross_1.default.setWindowName({ traceLink: traceLink });
            return traceLink;
        }
        catch (err) {
            console.log(err);
            return config_1.default.traceLink;
        }
    },
    // 修改traceLink
    setTraceLink: function (traceLink) {
        cross_1.default.setWindowName({ traceLink: traceLink });
        history.replaceState(null, null, base_fn_1.fn.setQueryString(document.URL, 'traceLink', JSON.stringify(traceLink)));
    }
};
exports.default = traceUtil;
