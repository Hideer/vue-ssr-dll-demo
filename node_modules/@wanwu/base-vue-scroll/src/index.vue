<template>
    <!-- 要改的 -->
    <div class="components__scroll">
        <div class="scroll__container">
            <div
                ref="slot__container"
                class="slot__container"
                :class="slotClass"
            >
                <slot></slot>
                <transition name="wanwu-slide-up">
                    <slot
                        name="bottom"
                    >
                        <div
                            v-if="showText"
                            ref="bottom"
                            class="bottom flex f-ai-c f-jc-c"
                            :style="loadingStyle"
                        >
                            <loading
                                v-if="hasMore"
                                :size="26"
                                class="loading"
                            ></loading>
                            {{ hasMore ? loadingText : noMoreText }}
                        </div>
                    </slot>
                </transition>
            </div>
        </div>
    </div>
</template>
<script>
    import loading from '@wanwu/base-vue-loading';
    import {
        fn,
    } from '@wanwu/base-fn';
    import '@wanwu/base-style';
    const {
        throttle,
    } = fn;

    export default {
        name: 'Scroll',
        components: {
            loading,
        },
        props: {
            loadingText: {
                type: String,
                default: '加载中...',
            },
            noMoreText: {
                type: String,
                default: '没有更多了',
            },
            loadingStyle: {
                type: [
                    Object,
                    String,
                ],
            },
            hasMore: {
                type: Boolean,
                default: true,
            },
            distanceToEdgeOffset: {
                type: Number,
                default: 2,
            },
            onReachBottom: {
                type: Function,
            },
            slotClass: {
                type: [
                    Object,
                    String,
                ],
            },
            loading: {
                type: Boolean,
                default: false,
            },
            showText: {
                type: Boolean,
                default: true,
            },
        },
        data() {
            return {
                handleScroll: () => {
                },
                atBottom: false,
                events: [
                    'scroll',
                    'wheel',
                    'mousewheel',
                    'resize',
                    'animationend',
                    'transitionend',
                    'touchmove',
                ],
            };
        },
        created() {
            this.handleScroll = throttle(this.scrollActive, 150);

            // window.addEventListener('scroll', this.handleScroll);
            this.bindEvents(true);
        },
        mounted() {
            this.$nextTick(this.handleScroll);
        },
        activated() {
            // window.addEventListener('scroll', this.handleScroll);
            this.bindEvents(true);
        },
        deactivated() {
            // window.removeEventListener('scroll', this.handleScroll);
            this.bindEvents(false);
        },

        beforeDestroy() {
            // window.removeEventListener('scroll', this.handleScroll);
            this.bindEvents(false);
        },
        methods: {
            scrollActive() {
                // if (this.hasMore) {
                //     let bottomY = this.$refs.bottom.getBoundingClientRect().y;
                //     let containerBottom =
                //         this.$refs.slot__container.getBoundingClientRect().y +
                //         this.$refs.slot__container.getBoundingClientRect().height;
                //     let toEdge = bottomY - containerBottom;
                //     if (toEdge < this.distanceToEdge && !this.loading) {
                //         this.onReachBottom && this.onReachBottom();
                //     }
                // }
                if (this.hasMore && !this.loading) {
                    const docE = document.documentElement;
                    const scrollTop = window.scrollY;
                    const clientHeight = docE.clientHeight;
                    // const bottomY = this.$refs.bottom.getBoundingClientRect().top;
                    const scrollHeight = docE.scrollHeight;
                    if (
                        scrollTop + clientHeight >= scrollHeight - (this.distanceToEdgeOffset * clientHeight)
                    ) {
                        if (this.onReachBottom) {
                            this.onReachBottom();
                        }
                        this.$emit('onReachBottom');

                        // this.onReachBottom && this.onReachBottom();
                    }
                }
            },
            bindEvents(isBind) {
                this.events.forEach(event => {
                    window[isBind ? 'addEventListener' : 'removeEventListener'](event, this.handleScroll);
                });
            },
        },
    };
</script>
<style lang="less" scoped>
.slot__container {
    /* margin-top: -1px; */

    /* overflow: scroll; */

    .bottom {
        width: 100%;
        overflow: hidden;
        font-size: 26px;
        text-align: center;
        height: 80px;
        color: #c9c9c9;

        .loading {
            margin-right: 15px;
        }
    }
}

@keyframes wanwu-slide-up-enter {
    from {
        transform: translate3d(0, 100%, 0);
    }
}

@keyframes wanwu-slide-up-leave {
    to {
        transform: translate3d(0, 100%, 0);
    }
}

.wanwu-slide-up-enter-active {
    animation: wanwu-slide-up-enter 0.3s both ease;
}

.wanwu-slide-up-leave-active {
    animation: wanwu-slide-up-leave 0.3s both ease;
}
</style>

