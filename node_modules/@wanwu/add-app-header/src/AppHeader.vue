<!-- @component index -->
<!-- created by zhaodazao at 2020/4/26 -->

<template>
    <div
        v-if="showHeader"
        :style="headerStyle || _headerStyle"
        class="component__AppHeader appHeader bg"
        :class="{ 'custom': custom, white:!isWhiteBg }"
    >
        <div
            v-if="nh && !custom"
            :style="nhStyle"
            class="appHeader-nh"
        ></div>
        <div class="appHeader-wrapper flex f-ai-c f-jc-c">
            <div class="left_btn absolute flex f-ai-c">
                <!-- 返回按钮位置插槽 -->
                <slot name="back" v-bind="headerBtn.back">
                    <template v-if="headerBtn.back.show">
                        <img
                            v-if="!isWhiteBg ? headerBtn.back.btnTransparentImgUrl : headerBtn.back.btnBlackImgUrl"
                            :src="!isWhiteBg ? headerBtn.back.btnTransparentImgUrl : headerBtn.back.btnBlackImgUrl"
                            class="back"
                            @click="clickFn('back')"
                        >
                        <i v-else-if="headerBtn.back.icon" class="WWDZ back icon" :class="[headerBtn.back.icon]" @click="clickFn('back')"></i>
                    </template>
                </slot>
            </div>
            <!-- 页面标题位置插槽 -->
            <slot name="title" v-bind="headerBtn.title">
                <span v-if="headerBtn.title.show && showTitle" :style="titleStyle" class="title" v-text="headerBtn.title.title"></span>
            </slot>
            <div class="right_btn flex f-ai-c absolute">
                <template v-for="key in ['refresh','share']">
                    <slot :name="key" v-bind="headerBtn[key]">
                        <template v-if="headerBtn[key].show">
                            <img
                                v-if="!isWhiteBg ? headerBtn[key].btnTransparentImgUrl : headerBtn[key].btnBlackImgUrl"
                                :key="key"
                                :src="!isWhiteBg ? headerBtn[key].btnTransparentImgUrl : headerBtn[key].btnBlackImgUrl"
                                :class="[key]"
                                @click="clickFn(key)"
                            >
                            <i v-else-if="headerBtn[key].icon" :key="key" class="WWDZ icon" :class="[headerBtn[key].icon,key]" @click="clickFn(key)"></i>
                        </template>
                    </slot>
                </template>
            </div>
        </div>
    </div>
</template>

<script>
    import hdp from '@wanwu/hdp';
    import { fn, ua } from '@wanwu/base-fn';

    import { isAPP, watchDocumentTitle, needShowAppHeader } from './utils';

    export default {
        name: 'AppHeader',
        props: {
            // 默认占位，实现原生APP内的头部效果
            // 针对店铺首页shop/index进行absolute定位处理
            top: {
                type: [
                    Number,
                    String,
                ],
            },
            // 是否自定义 -- 1.是：无背景，无nh，使用自定义top 2. 否：有背景，有nh，不使用自定义top
            custom: {
                type: Boolean,
                default: false,
            },
            // 是否展示documentTitle
            showTitle: {
                type: Boolean,
                default: true,
            },
            // title 样式更改
            titleColor: {
                type: String,
            },
            headerStyle: {
                type: Object,
            },
            // 是否展示分享按钮
            showShare: {
                type: Boolean,
                default: false,
            },
            // 组件使用的header隐藏显示
            showAppHeader: {
                type: Boolean,
                default: false,
            },
            // 自定义头部背景
            topBg: {
                type: String,
                default: '',
            },
            // nh高度背景
            nhBgColor: {
                type: String,
                default: '#fff',
            },
            // 是否默认展示（九宫预渲染专用）
            initShow: Boolean,
            // 按钮配置
            headerBtn: {
                type: Object,
                default: () => ({
                    back: {
                        // btnBlackImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/41aa6ba94c521e5159a96f6ffd0d36c6_72x72.png',
                        // btnTransparentImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/1bcff5b9e19f3a3c1ea173719d0da18b_72x72.png',
                        icon: 'ww-icon-fanhui5',
                        show: true,
                    },
                    title: {
                        title: document.title,
                        show: true,
                    },
                    refresh: {
                        // btnBlackImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/768d6767efad5a439b94de30b34dcd7e_75x72.png',
                        // btnTransparentImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/39fe7fe465725718632d61275bb8f8da_75x72.png',
                        icon: 'ww-icon-shuaxin1',
                        show: true,
                    },
                    share: {
                        // btnTransparentImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/630986d28d520a4682e0bc823c9f98a5_72x72.png',
                        // btnBlackImgUrl: 'https://cdn.wanwudezhi.com/static/web-static/image/63a786e8f9737d402f999928235e88b3_72x72.png',
                        icon: 'ww-icon-fenxiang1',
                        show: false,
                    },
                }),
            },
        },
        data() {
            return {
                hasDomain: false,
                nh: null,
                showHeader: this.showAppHeader || false,
                documentTitle: '玩物得志商城',
                noShare: true,
                appHeaderHeight: 0,
                uaNh: 0,
                isDP: !!this.getUaNhFromReg('StatusBarHeightDP'),
            };
        },
        computed: {
            _headerStyle() {
                const isImg = /^http(s)?:\/\//.test(this.topBg);
                const bgObj = isImg ? {
                    backgroundImage: this.topBg ? `url(${this.topBg})` : '',
                    backgroundSize: '100%',
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: 'center 99%',
                } : {
                    backgroundColor: this.topBg,
                };
                return {
                    height: this.appHeaderHeight + 'rem',
                    top: this.top && this.custom ? this.top + 'rem' : 0,
                    ...bgObj,
                };
            },
            titleStyle() {
                return {
                    color: this.titleColor,
                };
            },
            nhStyle() {
                return {
                    height: this.nh + 'rem',
                    background: this.topBg ? 'transparent' : this.nhBgColor,
                };
            },
            isWhiteBg() {
                return !(this.custom || this.topBg);
            },
        },
        watch: {
            showAppHeader(newVal) {
                if (newVal) {
                    this.setPublicHeaderHeight();
                }
            },
        },
        created() {
            this.setDocumentTitle = this.setDocumentTitle.bind(this);
            this.switchAppHeader();
            this.getUaNh();
        },
        activated() {
            this.switchAppHeader();
        },
        methods: {
            getUaNh() {
                this.uaNh = this.getUaNhFromReg('StatusBarHeightDP') * 2 || this.getUaNhFromReg('StatusBarHeight');
            },
            getUaNhFromReg(reg) {
                const uaNhReg = new RegExp(`\\s${reg}/([0-9]+)\\s?`);
                let uaNhMetch;
                try {
                    uaNhMetch = navigator.userAgent.match(uaNhReg);
                } catch (error) {
                    console.error(error);
                }
                return Number(uaNhMetch && uaNhMetch[1]);
            },
            // 开关
            switchAppHeader() {
                if (needShowAppHeader || this.initShow) {
                    // this.show();
                    this.$nextTick(() => watchDocumentTitle(this.setDocumentTitle, { immediate: true }));
                    this.setPublicHeaderHeight();
                    if (this.showShare) {
                        this.showAppHeaderShare();
                    } else {
                        this.hideAppHeaderShare();
                    }
                } else {
                    this.hide();
                }
            },
            // 提供给外部使用的隐藏分享的功能
            hideAppHeaderShare() {
                this.noShare = true;
                this.$set(this.headerBtn['share'], 'show', false);
            },
            showAppHeaderShare() {
                this.noShare = false;
                this.$set(this.headerBtn['share'], 'show', true);
            },
            // 提供给外部使用的更改头部背景的方法
            setTopBg(url) {
                this.topBg = url;
            },
            setTitleColor(val) {
                this.titleColor = val;
            },
            setNhBgColor(val) {
                this.nhBgColor = val;
            },
            setDocumentTitle() {
                this.$set(this.headerBtn['title'], 'title', document.title);
            },
            // 自定义Header包含功能：后退，刷新，分享
            clickFn(btnFn) {
                this.$emit(btnFn);
                if (btnFn === 'back') {
                    ua.isApp() ? hdp.execRequest('PluginNavigation', 'pageFinish') : this.$location.back();
                }
                if (btnFn === 'refresh') {
                    location.reload();
                }
                if (btnFn === 'share' && typeof window.commonShareClick === 'function') {
                    window.commonShareClick();
                }
            },
            // 设置拥有appHeader的document body的样式
            setDocumentBodyStyle() {
                document.body.style.paddingTop = this.appHeaderHeight + 'rem';
            },
            // 设置没有appHeader的document body的样式
            resetDocumentBodyStyle() {
                window.appHeaderHeight = 0;
                this.appHeaderHeight = 0;
                window.appHeaderNH = 0;
                document.body.style.paddingTop = '0';
            },
            // 设置提供给全局使用的appHeaderHeight与nh（手机状态栏高度）
            async setPublicHeaderHeight() {
                // 获取各个手机的状态栏
                let nh = fn.getQueryString('__nhDP') * 2 || fn.getQueryString('__nh');
                this.getUaNh();
                if (!nh && isAPP) {
                    try {
                        const response = await hdp.execRequest('PluginNavigation', 'pageStatusHeight');
                        if (response) {
                            nh = response.__nhDP * 2 || response.__nh;
                            if (!this.uaNh) this.setDocumentBodyStyle();
                        } else {
                            nh = 0;
                        }
                    } catch (e) {
                        console.log(e);
                        nh = 0;
                    }
                }
                this.setNh(nh);
            },
            // 兼容异步获取nh
            setNh(nh = 0) {
                this.getUaNh();
                let NumberNh = Number(nh);
                if (ua.getAppName() === 'wwdz_b2b' || fn.isLargerThanAppVersion('3.1.8')) {
                    if (ua.isIOSApp()) {
                        NumberNh = NumberNh * 2;
                    }
                } else {
                    if (ua.isIOSApp()) {
                        NumberNh = NumberNh + 10;
                    } else if (ua.isAndroidApp() && Number(nh)) {
                        NumberNh = NumberNh - 20;
                    }
                }
                if (!ua.isIOSApp()) {
                    NumberNh = this.uaNh || NumberNh;
                }
                const appHeaderHeight = (88 + NumberNh) / 100;
                const appHeaderNH = NumberNh / 100;
                this.nh = appHeaderNH;
                // 自定义头部高度
                window.appHeaderHeight = appHeaderHeight;
                this.appHeaderHeight = appHeaderHeight;
                window.appHeaderNH = appHeaderNH;
            },
            // 隐藏
            hide() {
                this.resetDocumentBodyStyle();
                this.showHeader = false;
            },
            // 展示
            show() {
                watchDocumentTitle(this.setDocumentTitle, { immediate: true });
                this.resetDocumentBodyStyle();
                this.setPublicHeaderHeight();
                this.setDocumentBodyStyle();
                this.showHeader = true;
            },
        },
    };
</script>

<style lang="less" scoped>
.appHeader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 3000;
    color: #2e333b;
    &-nh {
        width: 100%;
        background: #fff;
    }
    &.white{
        color: #fff;
    }
    &-wrapper {
        height: 88px;
        padding: 20px 0;
        .icon{
            font-size: 48px;
        }
        .title{
            font-size: 36px;
            white-space: nowrap;
            max-width: 460px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .share{
            margin-left: 48px;
        }

        img{
            width: 48px;
            display: block;
        }
        .absolute{
            position: absolute;
            &.left_btn{
                left: 28px;
            }
            &.right_btn{
                right: 28px;
            }
        }
    }
}

.bg {
    background: #fff;
}

.custom.bg {
    background: transparent;

    & > div:nth-child(2) {
        color: #fff;
    }
}

</style>
