<template>
    <div
        v-if="isShow"
        class="shareDialog component__shareDialog"
    >
        <popup
            v-model="value"
            position="bottom"
            :overlay="overlay"
            class="share-popup"
            wapper-class="flex f-fd-c f-jc-fe"
            :slot-style="{ height:'100%' }"
            @closed="onClosed"
        >
            <div
                ref="shareImgContainer"
                class="shareImgContainer flex f-fd-c f-ai-c f-jc-c f-fg-1"
                @click="popupInput(false)"
            >
                <!-- 实际能够看到的元素，用于异形的分享图，看到的是异形图，实际保存图片不一样 -->
                <!-- 下面的img覆盖在slot上，且img透明度设置为0，这样长按保存的是绘制的分享图，实际看到的是slot里的内容 -->
                <slot name="mask">
                </slot>

                <!-- canvas绘制的图片 -->
                <img
                    v-if="image && showTopShareImg"
                    v-lazy:[config]="image"
                    :style="{
                        opacity: isHide ? 0 : 1,
                        width: imageWitdh ? (imageWitdh / 100 + 'rem') : '' ,
                        maxHeight: containerHeight ? (containerHeight * 0.9 + 'px') : '',
                        ...shareImgStyle,
                    }"
                    class="shareImg f-fs-0"
                />
            </div>
            <div class="wrapper f-fs-0">
                <!-- 引导分享提示,默认`showTip`=true时展示tipImg为背景，tipText为文案的一个引导提示 -->
                <slot name="shareTip">
                    <div
                        v-if="showTip"
                        class="tip__wrap"
                    >
                        <img
                            v-lazy:[tipImg]="tipImg && tipImg.url"
                            class="tipImg"
                        />
                        <div class="tipText">
                            {{ tipText }}
                        </div>
                    </div>
                </slot>
                <div class="btnWrapper__wrap">
                    <div
                        v-if="image && !isApp"
                        class="download__tip"
                    >
                        长按上方图片保存或发送给朋友
                    </div>
                    <div
                        class="btnWrapper flex f-ai-c f-fw-w"
                        :class="shareBtnClass"
                    >
                        <template v-for="(item, key,index) in btnListObj">
                            <div
                                v-if="showBtn[key]"
                                :key="`${key}${index}`"
                                class="btn__item"
                                @click="item.method(showBtn[key])"
                            >
                                <img
                                    v-lazy="item.icon"
                                    class="btn__item--icon"
                                />
                                <div class="btn__item--text">
                                    {{ item.text }}
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <Occupying
                v-if="isIphoneX"
                class="Occupying"
                :height="56"
                bg-color="#F6F7F8"
            ></Occupying>
        </popup>
        <Dialog
            v-if="value"
            v-model="showDialog"
            class="Dialog"
            :overlay="false"
            :width="590"
            :offset-top="100"
        >
            <div
                slot="title"
                class="Dialog__title"
            >
                {{ dialogTitle }}
            </div>
            <div class="Dialog__content">
                <img
                    v-lazy="dialogImg"
                    class="Dialog__content--img"
                />
            </div>
        </Dialog>
    </div>
</template>
<script>
    import popup from '@wanwu/base-vue-popup';
    import Occupying from '@wanwu/base-vue-occupying';
    import {
        ua, fn,
    } from '@wanwu/base-fn';
    import Share from '@wanwu/base-share';
    import copyText from '@wanwu/copy-text';
    import Dialog from '@wanwu/base-vue-dialog';
    import hdp from '@wanwu/hdp';
    import User from '@wanwu/base-user';
    import {
        activeGoodsType,
    } from '@wanwu/resource-center';
    import {
        toast,
    } from '@wanwu/base-vue-toast';
    import {
        logE,
    } from '@wanwu/base-logger';
    import mySentry from '@wanwu/sentry';
    import request from '@wanwu/base-request';
    const {
        logError,
    } = mySentry;

    export default {
        name: 'ShareDialog',
        components: {
            popup,
            Occupying,
            Dialog,
        },
        props: {
            isHide: {
                type: Boolean,
                default: false,
            },
            // 分享海报的宽度
            imageWitdh: {
                type: Number,
            },
            /**
             * Promise Function resolve canvasConfig<br/>
             * 对应的canvasConfig规则可以参考<br/>canvas2image的文档<br/>
             * http://fe-material.wanwudezhi.work/?key=2&keypath=2-4<br/>
             * 或者 http://npm.wanwudezhi.com/package/@wanwu/canvas2image<br/>
             */
            initCanvasConfig: {
                type: Function,
            },
            // 弹窗显示隐藏
            value: {
                type: Boolean,
            },
            /**
             * 底部分享按钮，一共支持这几个key：<br/>
             * wxim(分享好友)<br/>
             * yjfq(一键发圈)<br/>
             * qq(分享到QQ)<br/>
             * wb(分享到微博)<br/>
             * hbfq(多图发圈，特定场景，一般没用)<br/>
             * saveImg(保存图片)<br/>
             * h5saveImg(h5保存图片提示)
             * copy(复制链接--默认复制 `标题加链接`)
             * **每一个key的值可以是`boolean`，true展示该按钮，false隐藏，如果是微信分享相关的，可以支持接受number类型的值**<br/>
             * 对应的类型来自于微信开放文档的mediaType<br/>
             * mediaType 0 文字类型 1 图片类型 2 音乐类型 3 视频类型 4 网页类型 5 小程序类型<br/>
             * 可以查看文档的**PluginShare - wechat**相关内容 http://wiki.wanwudezhi.work/pages/viewpage.action?pageId=329065<br/>
             * 分享相关的所有功能，除了复制链接，其他功能只支持app内使用
             */
            showBtn: {
                type: Object,
                default: () => ({
                    wxim: 4, // 分享好友
                    yjfq: ua.isApp() && 4, // 一件发圈
                    copy: true, // 复制链接
                    saveImg: true, // '保存图片' : '生成海报',
                    qq: ua.isApp() && fn.compareVersion(ua.getAppVersion(), '2.5.1') >= 0, // 分享qq
                    wb: ua.isApp() && fn.compareVersion(ua.getAppVersion(), '2.5.1') >= 0, // 分享weibo ,
                    h5saveImg: !ua.isApp(), // h5保存图片提示
                }),
            },
            // 是否展示顶部海报图片
            showTopShareImg: {
                type: Boolean,
            },
            // 分享配置对象，相关配置可以查看@wanwu/base-share<br/>
            // http://npm.wanwudezhi.com/package/@wanwu/base-share<br/>
            // 未完成，待补充<br/>
            shareObj: {
                type: Object,
            },
            /**
             * dialogImg
             * H5在微信环境下分享微信好友时的提示图片
             */
            dialogImg: {
                type: String,
                default: 'https://cdn.wanwudezhi.com/static/web-static/image/d18d05232f2e678babc1b1e530d20a8e.png',
            },
            shareImgStyle: {
                type: Object,
                default: () => ({}),
            },
            /**
             * 额外参数（社区用的，一般不建议使用）<br/>
             * `Function` extraParams.emitEventsFn 用户点击底部按钮后触发，触发时机和`shareComplete`事件一样，建议使用shareComplete<br/>
             * `string|number` extraParams.shareWayVal 用户点击底部分享按钮后上报埋点参数（shareWay）<br/>
             * `Object` extraParams.shareExtra 小程序分享参数，小程序/webview/share页面接收的参数，只有shareTaskType<br/>
             * `string` extraParams.shareExtra.shareTaskType 小程序分享参数，小程序/webview/share页面接收的参数<br/>
             */
            extraParams: {
                type: Object,
                default: () => ({}),
            },
            // 引导提示的文案
            tipText: {
                type: String,
            },
            // 引导提示对应的背景图片<br/>
            // {string} url 图片链接<br/>
            // {number} width 图片宽度<br/>
            // {number}  height 图片高度<br/>
            tipImg: {
                type: Object,
                default: () => ({
                    url: 'https://cdn.wanwudezhi.com/static/web-static/image/5c0d3a7d8f2e982b000cba89ca38555b_750x80.png',
                    width: 750,
                    height: 80,
                }),
            },
            // 是否展示引导提示
            showTip: {
                type: Boolean,
            },
        },
        data() {
            return {
                clickIcon: 'https://cdn.wanwudezhi.com/static/web-static/image/f186aa02245da380291c3568caedb213.png',
                image: null,
                dialogTitle: '点击“…”，选择【发送给朋友】或【分享到朋友圈】',
                showDialog: false,
                overlay: true,
                shareIcon:
                    'https://cdn.wanwudezhi.com/seller-admin/image/MTU1MjI4ODk3MTMwNA==.png',
                // dialogImg: 'https://cdn.wanwudezhi.com/static/web-static/image/d18d05232f2e678babc1b1e530d20a8e.png',
                qqdialogImg: 'https://cdn.wanwudezhi.com/static/web-static/image/3371d73466c0bca889d8da328f8d18dd_705x738.png',
                weibodialogImg: 'https://cdn.wanwudezhi.com/static/web-static/image/44d488ca5b1f4c9c68286a42146bfd34_705x738.png',

                isIphoneX: ua.isIPhoneX(),
                isApp: ua.isApp(),
                // promiseList: [],
                shareLinkShort: '',
                config: null,
                progress: 0,
                isShowLoading: false,
                // imgClass: 'widthFull',
                // shareImgWidth:
                // 避免created和watch里面的getShortChain重复调用
                isCreated: false,
                containerHeight: null,
                isQQInstalled: false,
                isWeiboInstalled: false,
            };
        },
        computed: {
            cntShareObj() {
                return Share.getCacheShareOptions(this.shareObj);
            },

            isShow() {
                return !this.checkIsProcessToWechatMiniProgram();
            },
            btnListObj() {
                const qqDisabledIcon = 'https://cdn.wanwudezhi.com/static/web-static/image/a5df314282c79e41aed71ef76625b14f_162x162.png';
                const qqEnabledIcon = 'https://cdn.wanwudezhi.com/static/web-static/image/5c060508ffaca870546c1d3616d268b6_162x162.png';
                const wbDisabledIcon = 'https://cdn.wanwudezhi.com/static/web-static/image/9e5101ebe824038430fc930d3811ab61_162x162.png';
                const wbEnabledIcon = 'https://cdn.wanwudezhi.com/static/web-static/image/49f12b068a29232789ef9c1f94cd8318_162x162.png';
                return {
                    wxim: {
                        key: 'wxim',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/7aaa81734c4cc9812dbb9968a47e1379_112x112.png',
                        text: '微信好友',
                        method: this.shareFriend,
                    },
                    yjfq: {
                        key: 'yjfq',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/c7eac16c4b6f0f125da1edc5f9bcf254_112x112.png',
                        text: '朋友圈',
                        method: this.shareMoment,
                    },
                    qq: {
                        key: 'qq',
                        icon: this.isQQInstalled ? qqEnabledIcon : qqDisabledIcon,
                        text: 'QQ',
                        method: this.shareToQQ,
                    },
                    wb: {
                        key: 'wb',
                        icon: this.isWeiboInstalled ? wbEnabledIcon : wbDisabledIcon,
                        text: '微博',
                        method: this.shareToWeibo,
                    },
                    // 海报发圈
                    hbfq: {
                        key: 'hbfq',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/1ff5d23aeb088e72d4ae96ee9be2a70e_112x112.png',
                        text: '海报发圈',
                        method: this.createPost,
                    },
                    saveImg: {
                        key: 'saveImg',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/f336e9a732b2260d40b3403d1fbe086e_112x112.png',
                        text: ua.isApp() ? '保存图片' : '生成海报',
                        method: this.saveImg,
                    },
                    h5saveImg: {
                        key: 'h5saveImg',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/f336e9a732b2260d40b3403d1fbe086e_112x112.png',
                        text: '保存图片',
                        method: this.toastSave,
                    },
                    copy: {
                        key: 'copy',
                        icon: 'https://cdn.wanwudezhi.com/static/web-static/image/d61e70204a951f43aeffd52ffb8df6e6_112x112.png',
                        text: '复制链接',
                        method: this.copyLink,
                    },
                };
            },
            // 控制样式， shareBtn > 3时，设置btnItem 宽度25%， 换行
            shareBtnClass() {
                const showBtn = Object.keys(this.showBtn).filter(key => this.showBtn[key]);
                if (showBtn.length > 4) {
                    return 'btnItemGreater4';
                } else {
                    return 'btnItemLess4';
                }
            },
        },
        watch: {
            initCanvasConfig() {
                this.image = null;
                this.shareLinkShort = null;
                this.progress = 0;
                this.config = null;
            },
            value(val) {
                if (val && this.checkIsProcessToWechatMiniProgram()) {
                    this.processToWechatMiniProgram();
                } else {
                    if (val && this.showTopShareImg) {
                        this.drawImage();
                    }
                    if (val && !this.shareLinkShort && !this.isCreated) {
                        this.getShortChain();
                    }
                }
            },
        },
        created() {
            if (this.value && this.checkIsProcessToWechatMiniProgram()) {
                this.processToWechatMiniProgram();
            } else if (this.value && this.showTopShareImg) {
                this.drawImage();
            }
            this.$nextTick(() => {
                this.getShortChain();
            });
            this.isCreated = true;
            if (ua.isApp()) {
                this.judgeQQandWeiboShareChannel();
            }

            if (ua.isQQ()) {
                this.dialogImg = this.qqdialogImg;
            }
            if (ua.isWeibo()) {
                this.dialogImg = this.weibodialogImg;
            }
        },
        methods: {
            // h5保存提示
            toastSave() {
                this.$emit('h5saveImg');
                this.$toast('请长按保存海报');
            },
            // 判断是否安装qq，weibo, 添加对应的分享渠道
            judgeQQandWeiboShareChannel() {
                try {
                    hdp.execRequest('PluginShare', 'isQQInstalled').then(res => {
                        this.isQQInstalled = res;
                    });
                    hdp.execRequest('PluginShare', 'isWeiboInstalled').then(res => {
                        this.isWeiboInstalled = res;
                    });
                } catch (e) {
                    console.log(e);
                }
            },
            onClosed() {
                // 弹窗关闭动画结束后
                this.$emit('closed');
            },
            extraFsEmit() {
                if (this.extraParams.emitEventsFn) this.extraParams.emitEventsFn();
            },
            popupInput(val) {
                // 弹窗显示隐藏状态修改，配合value实现v-module
                // @arg {boolean} value 弹窗显示隐藏状态
                this.$emit('input', val);
                if (!val) {
                    this.showDialog = false;
                }
            },
            logShare({
                shareTitle, link,
            }) {
                logE(30008, {
                    shareTitle: shareTitle,
                    shareUrl: link,
                    shareParameter: '',
                    shareWay: this.extraParams.shareWayVal || 0,
                });
                logE('share', {
                    shareTitle: shareTitle,
                    shareUrl: link,
                    shareParameter: '',
                    shareWay: this.extraParams.shareWayVal || 0,
                });
            },
            // 复制链接
            copyLink() {
                const shareTitle = 'copy';
                const link = this.genShareLink({
                    shareTitle,
                    needTitle: true,
                    short: true,
                });
                this.logShare({
                    shareTitle,
                    link,
                });
                copyText(link).then(res => {
                    toast('链接复制成功');
                }).catch(err => {
                    toast(err.message);
                });
                /**
                 * 用户点击底部分享按钮后触发
                 * @arg {string} action 用户点击的分享按钮类型
                 */
                this.$emit('shareComplete', 'copyLink');
                this.extraFsEmit();
            },
            // 分享好友
            shareFriend(type) {
                const shareTitle = 'wxim';
                const link = this.genShareLink({
                    shareTitle,
                });
                if (ua.isApp()) {
                    if (type && typeof type === 'boolean') {
                        type = 4;
                    }
                    this.shareToWx({
                        scene: 0,
                        mediaType: type,
                        shareType: shareTitle,
                    });
                } else {
                    this.showDialog = true;
                }
                this.logShare({
                    shareTitle,
                    link,
                });
                this.$emit('shareComplete', 'friend');
                this.extraFsEmit();
            },
            // 分享朋友圈
            shareMoment(type) {
                const shareTitle = 'yjfq';
                const text = this.genShareLink({
                    shareTitle: shareTitle,
                    needTitle: true,
                });
                const link = this.genShareLink({
                    shareTitle: shareTitle,
                });
                if (ua.isApp()) {
                    if (type && typeof type === 'boolean') {
                        type = 4;
                    }
                    copyText(text).then(res => {
                        // toast('链接已复制');
                    }).catch(err => {
                        toast(err.message);
                    });
                    this.shareToWx({
                        scene: 1,
                        mediaType: type,
                        shareType: shareTitle,
                    });
                    this.$emit('shareComplete', 'moment');
                    this.extraFsEmit();
                } else {
                    this.showDialog = true;
                }
                this.logShare({
                    shareTitle,
                    link,
                });
            },
            shareImgShow() {
                // this.image = val;
                this.popupInput(false);
            },
            // 保存图片
            saveImg() {
                const shareTitle = 'saveImg';
                const link = this.genShareLink({
                    shareTitle,
                });
                if (ua.isApp() && this.image) {
                    this.$share.downloadImageByHdp(this.image, this);
                }
                this.$emit('shareComplete', 'saveImage');
                this.extraFsEmit();
                this.logShare({
                    shareTitle,
                    link,
                });
            },
            async  shareToWx({
                scene, mediaType, shareType,
            }) {
                const text = this.genShareLink({
                    shareTitle: shareType,
                    needTitle: true,
                });
                const link = this.genShareLink({
                    shareTitle: shareType,
                });
                if (ua.isApp()) {
                    let miniName;
                    try {
                        const res = await activeGoodsType();
                        miniName = res.miniName;
                    } catch {
                        miniName = 'gh_1cc1b1adba60';
                    }
                    const shareObj = this.cntShareObj;
                    const canTailoring = shareObj.imgUrl.indexOf('cdn.wanwudezhi') > -1 && !(ua.isIOSApp() && shareObj.imgUrl.indexOf('vframe') > -1);
                    const imgUrl = canTailoring ? this.getRectangleImage(shareObj.imgUrl, {
                        cut: true,
                        width: 500,
                        height: mediaType === 5 ? 400 : 500,
                    }) : shareObj.imgUrl;
                    // 调用app接口
                    return hdp.exec('PluginShare', 'wechat', {
                        scene: scene, // 分享场景
                        text: text, // 发送消息的文本内容
                        title: shareObj.title, // 消息标题
                        description: shareObj.desc, // 消息描述
                        thumbData: imgUrl, // 缩略图
                        mediaType: mediaType, // 分享媒体消息类型
                        mediaObject: {
                            imageData: this.image,
                            // 根据微信开放平台文档里的媒体消息类型
                            webpageUrl: link, // 兼容低版本的网页链接
                            userName: miniName || 'gh_1cc1b1adba60', // 小程序的userName
                            path: '/pages' + shareObj.page + '?' + shareObj.queryStr, // 小程序的页面路径
                            withShareTicket: true, // 是否使用带shareTicket的分享(详情见微信开放平台文档)
                            miniprogramType: parseInt(fn.getQueryString('__miniprogramType')) || 0, // 小程序的类型
                            hdImageData: imgUrl,
                        },
                    });
                }
            },
            // 分享到qq
            async shareToQQ() {
                if (!this.isQQInstalled) { this.$toast('当前设备未检测到QQ'); return; }
                const {
                    title,
                    desc,
                    imgUrl,
                } = this.cntShareObj;
                const shareTitle = 'qq';
                const link = this.genShareLink({
                    shareTitle,
                });
                // const shareUrl = fn.setQueryString(link, 'shareTitle', 'qq');
                // qq不支持webp格式图片，兼容
                const thumbData = imgUrl.indexOf('webp') > -1 ? imgUrl.replace('webp', '') : imgUrl;
                try {
                    await hdp.exec('PluginShare', 'qq', {
                        title,
                        desc,
                        thumbData,
                        webpageUrl: link,
                    });
                } catch (e) {
                    console.log(e);
                }
                this.$emit('shareComplete', 'qq');
                this.extraFsEmit();
                this.logShare({
                    shareTitle,
                    link,
                });
            },
            // 分享到微博
            async shareToWeibo() {
                if (!this.isWeiboInstalled) { this.$toast('当前设备未检测到微博'); return; }
                const {
                    title,
                    desc,
                    imgUrl,
                } = this.cntShareObj;
                const shareTitle = 'wb';
                const link = this.genShareLink({
                    shareTitle,
                });
                try {
                    await hdp.exec('PluginShare', 'weibo', {
                        title,
                        desc,
                        thumbData: imgUrl,
                        webpageUrl: link,
                    });
                } catch (e) {
                    console.log(e);
                }
                this.$emit('shareComplete', 'weibo');
                this.logShare({
                    shareTitle,
                    link,
                });
            },
            // 海报发圈
            createPost() {
                hdp.execRequest('PluginNavigation', 'createShare');
                this.$emit('shareComplete', 'post');
                this.extraFsEmit();
            },
            async drawImage(/* viewImg */) {
                // let promiseDrawImage;
                if (!this.image) {
                    this.showLoading();
                    this.initCanvasConfig().then(config => {
                        this.config = config;
                        return this.$share.drawImg(config);
                    }).then(res => {
                        this.image = res;
                        if (this.$refs.shareImgContainer) {
                            this.containerHeight = this.$refs.shareImgContainer.offsetHeight;
                        }
                    }).catch(err => {
                        logError(err);
                        toast(err.message);
                        this.$emit('input', false);
                    }).finally(() => {
                        this.$emit('drawEnd', this.image);
                        this.progressCloseLoading();
                    });
                }
            },
            // /api/notify/itemShortUrl/getItemShortUrl
            async  getShortChain() {
                // if (!this.shareLinkShort) {
                //     await this.$request.post('/api/notify/itemShortUrl/getItemShortUrl', {
                //         url: this.cntShareObj.link,
                //         userId: User.getUserInfo().userId,
                //     }).then(res => {
                //         this.shareLinkShort = res;
                //     }).catch(this.$logError);
                //     this.progressCloseLoading();
                // } else {
                //     this.progressCloseLoading();
                // }
                await getShortChain(this.cntShareObj).then(res => {
                    this.shareLinkShort = res;
                }).catch(this.$logError);
                this.progressCloseLoading();
            },
            showLoading() {
                if (!this.isShowLoading) {
                    this.$loadingToast.show();
                    this.isShowLoading = true;
                }
            },
            progressCloseLoading() {
                this.progress++;
                // console.log('progressCloseLoading', this.progress);

                if (this.progress >= 2 && this.isShowLoading) {
                    this.$loadingToast.close();
                    this.isShowLoading = false;
                    this.isCreated = false;
                }
            },
            async processToWechatMiniProgram() {
                this.$loadingToast.show();
                const shareObj = this.cntShareObj;
                const config = this.config || (await this.initCanvasConfig());
                this.config = config;
                config.copyData = shareObj.link;

                const canTailoring = shareObj.imgUrl.indexOf('cdn.wanwudezhi') > -1 && !(ua.isIOSApp() && shareObj.imgUrl.indexOf('vframe') > -1);
                const imgUrl = canTailoring ? this.getRectangleImage(shareObj.imgUrl, {
                    cut: true,
                    width: 500,
                    height: 400,
                }) : shareObj.imgUrl;

                const shareInfo = {
                    path: '/pages' + shareObj.page + '?' + shareObj.queryStr,
                    title: shareObj.title,
                    imageUrl: imgUrl,
                };

                this.popupInput(false);
                this.$loadingToast.close();

                const extraParams = this.extraParams || {};
                const shareExtra = extraParams.shareExtra || {};
                const shareTaskType = shareExtra.shareTaskType || '';

                this.$location.push(fn.stringifyUrl('/webview/share', {
                    shareInfo: JSON.stringify(shareInfo),
                    config: JSON.stringify(config),
                    shareTaskType,
                }));
            },
            checkIsProcessToWechatMiniProgram() {
                const xcxVersion = fn.getQueryString('xcxVersion');
                return ua.isWechatMiniProgram() && xcxVersion && fn.compareVersion(xcxVersion, '2.0.62') >= 0;
            },
            genShareLink({
                shareTitle,
                needTitle,
                short,
            }) {
                const link = fn.setQueryString((short ? this.shareLinkShort : this.cntShareObj.link), 'shareTitle', shareTitle);
                const text = `${this.cntShareObj.title}\r\n${link}`;
                if (needTitle) {
                    return text;
                } else {
                    return link;
                }
            },
        },
    };
    const getShortChainCache = {};
    export async function getShortChain({
        link, realLink,
    }) {
        const key = realLink || link;
        if (!getShortChainCache[key]) {
            getShortChainCache[key] = request.post('/api/notify/itemShortUrl/getShortUrl', {
                url: link,
                userId: User.getUserInfo().userId,
            }).catch(err => {
                delete getShortChainCache[key];
                return Promise.reject(err);
            });
        }
        return getShortChainCache[key];
    }
</script>
<style lang="less" scoped>
    .component__shareDialog {
        .Dialog {
            &__title {
                font-size: 28px;
                font-weight: 500;
                color: rgba(30, 30, 30, 1);
                line-height: 40px;
                padding: 0 40px;
            }

            &__content {
                padding: 50px 60px 42px;

                &--img {
                    width: 470px;
                    display: block;
                }
            }
        }

        // .button {
        //     right: 0;
        //     bottom: 160px;
        //     padding: 0;
        //     background-color: transparent;
        // }
        // .btn-img {
        //     width: 166px;
        //     height: 110px;
        // }
        .share-popup {
            height: 100%;
        }

        .shareImgContainer {
            max-height: 100%;
            // padding-bottom: 30px;
        }

        .shareImg {
            // max-width: 70%;
            // max-height: 50%;
            // width: 500px;
            max-width: 580px;
            display: block;
            // margin: 0 auto;

            &__toast {
                // padding: 10px 30px;
                // background-color: rgba(50, 50, 51, 0.88);
                // color: #fff;
                // font-size: 26px;
                // line-height: 40px;
                // border-radius: 16px;
                // 注释掉样式
                // position: absolute;
                // top: -88px;
                // left: 50%;
                // transform: translateX(-50%);
                margin-bottom: 10px;

                &--icon {
                    max-width: 490px;
                    display: block;
                }

                // &--text {
                //     margin-left: 10px;
                //     white-space: nowrap;
                // }
            }
        }

        .tip__wrap {
            width: 100%;
            height: 80px;
            position: relative;

            .tipImg {
                width: 100%;
                height: 80px;
                display: block;
                object-fit: cover;
            }

            .tipText {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 80px;
                line-height: 80px;
                text-align: center;
                font-size: 30px;
                color: #fff;
                font-weight: 500;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
        }

        .btnWrapper__wrap {
            background-color: #f6f7f8;

            .download__tip {
                position: relative;
                top: 16px;
                font-size: 26px;
                color: #63666c;
                text-align: center;
                // padding-top: 10px;
            }
        }

        .btnWrapper {
            width: 750px;
            height: 200px;
            background: #f6f7f8;

            .btn__item {
                &--icon {
                    width: 80px;
                    height: 80px;
                    display: block;
                    margin: 0 auto;
                }

                &--text {
                    font-size: 24px;
                    font-weight: 400;
                    color: rgba(15, 15, 15, 1);
                    margin-top: 14px;
                    text-align: center;
                }
            }
        }
        // 分享按钮的数量大于4的class
        .btnItemGreater4 {
            height: 4rem;
            flex-flow: row wrap;

            .btn__item {
                width: 25%;
            }
        }
        // 分享按钮的数量小于等于4的class
        .btnItemLess4 {
            height: 2rem;
            justify-content: space-around;
        }
    }
</style>
