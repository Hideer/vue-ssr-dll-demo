<template>
    <div>
        <div
            :style="refreshStyle"
            class="refresh"
        >
            <div
                ref="track"
                class="refresh__track"
                :style="trackStyle"
            >
                <div
                    class="refresh__head"
                    :style="headStyle"
                >
                    <div
                        v-if="textStatus.indexOf(status) !== -1"
                        class="pull"
                    >
                        <img
                            class="img"
                            :src="stateImgObj.loading"
                            alt=""
                        >
                        <div class="words">
                            松开立即刷新
                        </div>
                    </div>
                    <div
                        v-if="status === 'loading' || status === 'success'"
                        class="loading"
                    >
                        <img
                            class="img"
                            :src="stateImgObj.loading"
                            alt=""
                        >
                        <div class="active">
                            <img
                                class="img1"
                                :src="stateImgObj.success"
                                alt=""
                            >
                        </div>
                        <div class="words">
                            {{ status === 'success' ? '刷新完成' : '正在刷新' }}
                        </div>
                    </div>
                </div>
                <slot></slot>
            </div>
        </div>
    </div>
</template>

<script>
    import { TouchMixin } from './mixin/touch.js';
    import { ua } from '@wanwu/base-fn';
    const DEFAULT_HEAD_HEIGHT = 60;
    const TEXT_STATUS = [
        'pulling',
        'loosing',
    ];
    export default {
        name: 'Refresh',
        mixins: [
            TouchMixin,
        ],
        props: {
            refreshStyle: {
                type: Object,
                default: () => {
                    return {};
                },
            },
            stateImgKey: String,
            disabled: Boolean,
            successText: String,
            pullingText: String,
            loosingText: String,
            loadingText: String,
            value: {
                type: Boolean,
                required: true,
            },
            successDuration: {
                type: [
                    Number,
                    String,
                ],
                default: 500,
            },
            animationDuration: {
                type: [
                    Number,
                    String,
                ],
                default: 300,
            },
            headHeight: {
                type: [
                    Number,
                    String,
                ],
                default: DEFAULT_HEAD_HEIGHT,
            },
            hasStatusbar: {
                type: Boolean,
                default: false,
            },
            headPaddingTop: {
                type: Number,
                default: 20,
            },
            loadingEnd: {
                type: Boolean,
            },
        },
        data() {
            return {
                status: 'normal',
                distance: 0,
                duration: 0,
                textStatus: TEXT_STATUS,
                stateImgObj: {},
                stateImgMap: {
                    wwdz: {
                        loading: 'https://cdn.wanwudezhi.com/static/web-static/image/cb2b45382d9afba05862ac8c208bb812_84x84.png',
                        success: 'https://cdn.wanwudezhi.com/static/web-static/image/dadb60d148d7cb568499fee4cfafedb9_84x84.png',
                    },
                    common: {
                        loading: 'https://cdn.wanwudezhi.com/static/web-static/image/9406edf898fe9840aa02f291c9ad328e_84x84.png',
                        success: 'https://cdn.wanwudezhi.com/static/web-static/image/6ab32b7a1f19164a9a5beaf22f1acd07_84x84.png',
                    },
                },
                isIphoneX: ua.isIPhoneX(),
            };
        },
        computed: {
            trackStyle() {
                return {
                    'transition-duration': `${this.duration}ms`,
                    transform: this.distance ? `translate3d(0,${this.distance / window.rem}rem, 0)` : '',
                };
            },
            showStatusText() {
                return this[`${status}Text`];
            },
            touchable() {
                return (
                    this.status !== 'loading' && this.status !== 'success' && !this.disabled
                );
            },
            headStyle() {
                const style = {};
                if (this.componentHeaderHeight !== DEFAULT_HEAD_HEIGHT) {
                    style.height = `${this.componentHeaderHeight / window.rem}rem`;
                }
                style.paddingTop = `${this.headerPaddingTop / window.rem}rem`;
                return style;
            },
            headerPaddingTop() {
                let paddingTop = this.headPaddingTop;
                if (this.hasStatusbar && this.isIphoneX) {
                    paddingTop += 20;
                }
                return paddingTop;
            },
            componentHeaderHeight() {
                let headHeight = this.headHeight + this.headPaddingTop;
                if (this.hasStatusbar && this.isIphoneX) {
                    headHeight += 20;
                }
                return headHeight;
            },
        },
        watch: {
            value(loading) {
                this.duration = this.animationDuration;
                if (loading) {
                    this.setStatus(+this.componentHeaderHeight, true);
                } else if (this.loadingEnd) {
                    this.status = 'success';
                    setTimeout(() => {
                        this.setStatus(0, false);
                    }, 300);
                } else {
                    this.setStatus(0, false);
                }
            },
        },
        created() {
            this.stateImgObj = this.stateImgMap.wwdz;
            if (window.hidewwdz) {
                this.stateImgObj = this.stateImgMap.common;
            }
            if (this.stateImgKey && this.stateImgMap[this.stateImgKey]) {
                this.stateImgObj = this.stateImgMap[this.stateImgKey];
            }
        },
        mounted() {
            this.bindTouchEvent(this.$refs.track);
            this.scrollEl = this.getScroller(this.$el);
        },
        methods: {
            slots(name = 'default', props) {
                const {
                    $slots, $scopedSlots,
                } = this;
                const scopedSlot = $scopedSlots[name];

                if (scopedSlot) {
                    return scopedSlot(props);
                }
                return $slots[name];
            },
            preventDefault(event, isStopPropagation) {
                if (typeof event.cancelable !== 'boolean' || event.cancelable) {
                    event.preventDefault();
                }
                if (isStopPropagation) {
                    event.stopPropagation();
                }
            },
            getScrollTop(el) {
                return 'scrollTop' in el ? el.scrollTop : el.pageYOffset;
            },
            getScroller(el, root = window) {
                const overflowScrollReg = /scroll|auto/i;
                let node = el;
                while (
                    node &&
                    node.tagName !== 'HTML' &&
                    node.nodeType === 1 &&
                    node !== root
                ) {
                    const {
                        overflowY,
                    } = window.getComputedStyle(node);

                    if (overflowScrollReg.test(overflowY)) {
                        if (node.tagName !== 'BODY') {
                            return node;
                        }
                        // see: https://github.com/youzan/vant/issues/3823
                        const {
                            overflowY: htmlOverflowY,
                        } = window.getComputedStyle(
                            node.parentNode,
                        );

                        if (overflowScrollReg.test(htmlOverflowY)) {
                            return node;
                        }
                    }
                    node = node.parentNode;
                }

                return root;
            },
            checkPullStart(event) {
                this.ceiling = this.getScrollTop(this.scrollEl) === 0;

                if (this.ceiling) {
                    this.duration = 0;
                    this.touchStart(event);
                }
            },
            onTouchStart(event) {
                if (this.touchable) {
                    this.checkPullStart(event);
                }
            },
            onTouchMove(event) {
                if (!this.touchable) {
                    return;
                }

                if (!this.ceiling) {
                    this.checkPullStart(event);
                }

                this.touchMove(event);

                if (this.ceiling && this.deltaY >= 0 && this.direction === 'vertical') {
                    this.preventDefault(event);
                    this.setStatus(this.ease(this.deltaY));
                }
            },
            onTouchEnd() {
                if (this.touchable && this.ceiling && this.deltaY) {
                    this.duration = this.animationDuration;

                    if (this.status === 'loosing') {
                        this.setStatus(+this.componentHeaderHeight, true);
                        this.$emit('input', true);
                        // ensure value change can be watched
                        this.$nextTick(() => {
                            this.$emit('refresh');
                        });
                    } else {
                        this.setStatus(0);
                    }
                }
            },
            ease(distance) {
                const headHeight = +this.componentHeaderHeight;

                if (distance > headHeight) {
                    if (distance < headHeight * 2) {
                        distance = headHeight + (distance - headHeight) / 2;
                    } else {
                        distance = headHeight * 1.5 + (distance - headHeight * 2) / 4;
                    }
                }
                return Math.round(distance);
            },
            setStatus(distance, isLoading) {
                let status;
                if (isLoading) {
                    status = 'loading';
                } else if (distance === 0) {
                    status = 'normal';
                } else {
                    status = distance < this.componentHeaderHeight ? 'pulling' : 'loosing';
                }

                this.distance = distance;

                if (status !== this.status) {
                    this.status = status;
                }
            },
            genStatus() {
                const {
                    status, distance,
                } = this;
                const slot = this.slots(status, {
                    distance,
                });
                if (slot) {
                    return slot;
                }

                const nodes = [];
                // const text = this[`${status}Text`];

                if (TEXT_STATUS.indexOf(status) !== -1 || status === 'loading') {
                    nodes.push('<div class="text">加载中</div>');
                }
                return nodes;
            },
            showSuccessTip() {
                this.status = 'success';

                setTimeout(() => {
                    this.setStatus(0);
                }, this.successDuration);
            },
        },
    };
</script>

<style lang="less" scoped>
@keyframes myHeight {
    0% {
        height: 0;
    }

    50% {
        height: 28px;
    }

    100% {
        height: 56px;
    }
}

@-webkit-keyframes myHeight {
    0% {
        height: 0;
    }

    50% {
        height: 28px;
    }

    100% {
        height: 56px;
    }
}

.refresh {
    overflow: hidden;
    user-select: none;

    &__track {
        position: relative;
        height: 100%;
        transition-property: transform;
    }

    &__head {
        position: absolute;
        left: 0;
        width: 100%;
        text-align: center;
        transform: translateY(-100%);

        .pull {
            text-align: center;

            .img {
                display: block;
                margin: auto;
                width: 56px;
                height: 56px;
            }

            .words {
                padding-top: 12px;
                padding-bottom: 22px;
                font-size: 28px;
                font-weight: 400;
                color: rgba(99, 102, 108, 1);
                line-height: 40px;
            }
        }

        .success {
            text-align: center;

            .img {
                display: block;
                margin: auto;
                width: 56px;
                height: 56px;
            }

            .words {
                padding-top: 12px;
                padding-bottom: 22px;
                font-size: 28px;
                font-weight: 400;
                color: rgba(99, 102, 108, 1);
                line-height: 40px;
            }
        }

        .loading {
            text-align: center;
            position: relative;

            .img {
                display: block;
                margin: auto;
                width: 56px;
                height: 56px;
            }

            .active {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                bottom: 72px;
                display: block;
                width: 56px;
                // height: 56px;
                z-index: 100;
                animation: myHeight 1s linear;
                animation-fill-mode: forwards;
                overflow: hidden;

                .img1 {
                    width: 100%;
                    display: block;
                    position: absolute;
                    bottom: 0;
                }
            }

            .words {
                padding-top: 12px;
                padding-bottom: 22px;
                font-size: 28px;
                font-weight: 400;
                color: rgba(99, 102, 108, 1);
                line-height: 40px;
            }
        }
    }
}

</style>
