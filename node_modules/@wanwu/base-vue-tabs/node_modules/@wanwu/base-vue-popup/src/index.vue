<template>
    <div class="popup__root">
        <transition
            :name="transitionName"
            :duration="duration"
            @afterEnter="$emit('opened')"
            @afterLeave="$emit('closed')"
        >
            <div
                v-if="value"
                v-fixed="fixed"
                class="popup__slot--container components__popup"
                :class="'popup__' + (position || 'center')"
                style="z-index: 4000;"
                :style="slotStyle"
                @click="$emit('slotClick')"
            >
                <div :style="slotStyle">
                    <div
                        class="translate__wapper"
                        :style="{ transition:(duration / 1000) + 's',...slotStyle }"
                        :class="[wapperClass,{ 'translate__wapper_ipx':chnageTranslate }]"
                    >
                        <slot></slot>
                    </div>
                </div>
            </div>
        </transition>
        <overlay
            class="overlay"
            :value="showOverlay"
            :overlay-style="overlayStyle"
            @click="closePopup"
        ></overlay>
    </div>
</template>
<script>
    import overlay, {
        // Overlay,
    } from '@wanwu/base-vue-overlay';
    import { ua } from '@wanwu/base-fn';
    export default {
        name: 'Popup',
        components: {
            overlay,
        },
        directives: {
            fixed: {
                inserted(el, fixed, vnode) {
                    if (!fixed.value) return;

                    const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
                    if (window.currentRouterView) {
                        window.currentRouterView.style.overflow = 'hidden !important';
                    } else {
                        document.body.style.cssText += 'position:fixed;width:100%;height:100%;top:-' + scrollTop + 'px;';
                    }
                },
                // unbind 指令与元素解绑时调用
                unbind(el, fixed, vnode) {
                    // if (fixed.value) vnode.context.unBindFixed();
                },
            },
        },
        props: {
            value: {
                type: Boolean,
                default: false,
            },
            overlay: {
                type: Boolean,
                default: true,
            },
            closeOnClickOverlay: {
                type: Boolean,
                default: true,
            },
            position: {
                type: String,
                default: '',
            },
            overlayStyle: {
                type: [
                    Object,
                    String,
                ],
            },
            slotStyle: {
                type: [
                    Object,
                    String,
                ],
            },
            // 是否允许页面滚动
            fixed: {
                type: Boolean,
                default: false,
            },
            wapperClass: {
                type: [
                    Object,
                    String,
                ],
            },
            duration: {
                type: Number,
                default: 300,
            },
        },
        data() {
            return {
                vmOverlay: null,
                overlayOpened: false,
                showOverlay: false,
                chnageTranslate: ua.isWechatMiniProgram() && ua.isIPhoneX(),
            };
        },
        computed: {
            transitionName() {
                let transitionName = 'popup-slide-';
                if (this.position) {
                    transitionName += this.position;
                } else {
                    transitionName = 'popup-fade';
                }
                return transitionName;
            },
        },
        watch: {
            value(val) {
                const type = val ? 'open' : 'close';
                this[type]();
                this.$emit(type);
            },
        },
        mounted() {
            if (this.value) {
                this.open();
            }
        },
        activated() {
            if (this.value) {
                this.open();
            }
        },

        beforeDestroy() {
            this.close();
        },

        deactivated() {
            this.close();
        },
        methods: {
            closePopup() {
                if (this.closeOnClickOverlay) {
                    this.$emit('input', false);
                }
                this.$emit('click-overlay');
            },
            open() {
                if (this.overlay) {
                    this.showOverlay = true;
                }
            },
            close() {
                this.showOverlay = false;
                this.$emit('input', false);
                this.unBindFixed();
            },
            unBindFixed() {
                if (this.fixed) {
                    if (window.currentRouterView) {
                        window.currentRouterView.style.overflow = 'scroll !important';
                    } else {
                        const body = document.body;
                        body.style.position = '';
                        const top = body.style.top;
                        document.body.scrollTop = document.documentElement.scrollTop = -parseInt(top);
                        body.style.top = '';
                    }
                }
            },
        },
    };
</script>
<style lang="postcss" scoped>
.popup__slot--container {
    position: fixed;
    max-height: 100%;
    pointer-events: none;

    .translate__wapper {
        transition: 0.3s;
        max-height: 100%;
        pointer-events: auto;
    }
}

.popup__center {
    top: 50%;
    left: 50%;

    .translate__wapper {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
    .translate__wapper_ipx{
        transform: translate(-50%, calc(-50% - 50px));
    }
}

.popup__top {
    width: 100%;
    top: 0;
    right: auto;
    bottom: auto;
    left: 0;

    /* transform: translate3d(-50%, 0, 0); */
}

.popup__bottom {
    width: 100%;
    top: auto;
    bottom: 0;
    right: auto;
    left: 0;

    /* transform: translate3d(-50%, 0, 0); */
}

.popup__right {
    top: 50%;
    right: 0;
    bottom: auto;
    left: auto;

    .translate__wapper {
        transform: translate(0, -50%);
    }
}

.popup__left {
    top: 50%;
    left: 0;
    bottom: auto;
    right: auto;

    .translate__wapper {
        transform: translate(0, -50%);
    }
}

.popup {
    &-slide-top-enter,
    &-slide-top-leave-active {
        .translate__wapper {
            transform: translate(0, -100%);
        }
    }

    &-slide-right-enter,
    &-slide-right-leave-active {
        .translate__wapper {
            transform: translate(100%, -50%);
        }
    }

    &-slide-bottom-enter,
    &-slide-bottom-leave-active {
        .translate__wapper {
            transform: translate(0, 100%);
        }
    }

    &-slide-left-enter,
    &-slide-left-leave-active {
        .translate__wapper {
            transform: translate(-100%, -50%);
        }
    }

    &-fade-enter,
    &-fade-leave-active {
        .translate__wapper {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8, 0.8);
        }
    }
}
</style>
