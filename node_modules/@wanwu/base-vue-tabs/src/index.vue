<template>
    <div
        ref="container"
        class="component__tabs tabs"
        :class="{
            'tabs-relative': sticky,
            'tabs-card': type === 'card',
            'tabs-new': type === 'newModel',
            'tabs-icon': type === 'icon',
        }"
        :style="[containerStyle]"
    >
        <div
            ref="bar"
            :class="[typeof hiddenBar === 'boolean' ? 'will_hiddenBar' : '', hiddenBar ? 'hiddenBar' : '', showAll ? 'tabs-bar-showall' : '']"
            class="tabs-bar"
            :style="[barStyle, fixedStyle, customTabbarStyle]"
        >
            <slot name="nav-left"></slot>
            <div
                ref="barbody"
                class="tabs-tab-wrap"
                :class="{ 'scrollable' : scrollable, 'tab-autoWidth': tabAutoWidth, }"
            >
                <!-- 标签页标题，通过v-for实现循环 -->
                <div
                    v-for="(item, index) in navList"
                    :key="item.name + '' + index"
                    ref="tabWraps"
                    class="tabs-tab"
                    :class="{
                        'split-line': splitLine || (type === 'icon' && splitLine === undefined),
                        'tabs-tab-active': item.name === currentValue,
                    }"
                    :style="[tabStyle,customTabStyle,item.name === currentValue ? customActiveStyle : {}]"
                    @click="handleClick(index)"
                >
                    <!-- 图标模式 -->
                    <div v-if="type === 'icon'" ref="tabs" class="tabs-label">
                        <div class="tabs-label--content flex f-ai-c">
                            <div class="icon__wrap">
                                <img v-if="item.iconImage" :src="item.iconImage" :style="iconStyle">
                                <i v-if="item.iconFont" :class="item.iconFont" :style="iconStyle"></i>
                            </div>
                            <div class="label">
                                {{ item.label }}
                            </div>
                        </div>
                    </div>
                    <div v-else ref="tabs" class="tabs-label">
                        <div class="tabs-label--content">
                            {{ item.label }}
                        </div>
                    </div>
                </div>

                <!-- 下划线插槽 -->
                <div
                    v-if="($slots.line || (useSlotLine && type === 'newModel')) && (type === 'line' || type === 'newModel')"
                    ref="line"
                    class="tabs-bar--line-position"
                    :style="[lineStyle, customLineStyle]"
                >
                    <slot name="line">
                        <div class="line__slot">
                            <i class="WWDZ ww-icon-xuanzhong"></i>
                        </div>
                    </slot>
                </div>
                <div
                    v-else-if="type === 'line' || type === 'newModel'"
                    class="tabs-bar--line-position tabs-bar--line"
                    :style="[lineStyle, customLineStyle]"
                ></div>
                <div v-if="showAll" class="showAllOccupying" :style="showAllStyle.customIconStyle"></div>
            </div>
            <slot name="nav-right"></slot>
            <!-- 查看全部按钮 -->
            <div v-if="showAll" class="arrow__wrap" :style="showAllStyle.customIconStyle">
                <div
                    v-if="!showAllStyle.hiddenBg"
                    class="arrow__bg"
                    :style="showAllBgStyle"
                ></div>
                <div class="arrow__wrap--click" :style="allPopupShow ? 'z-index: 1002;' : ''" @click="showAllClick">
                    <slot name="show-all">
                        <div class="arrow__icon">
                            <i
                                :class="`WWDZ ${showAllStyle.iconFont || 'ww-icon-xiala'}`"
                                :style="allPopupShow ? 'transform: rotate(180deg);' : 'transform: rotate(0deg);'"
                            ></i>
                        </div>
                    </slot>
                </div>
                <AllPopup
                    v-model="allPopupShow"
                    :list="navList"
                    :active="currentValue"
                    :top="popupTop"
                    :custom-style="showAllStyle.customPopupStyle"
                    @change="allTabsChange"
                ></AllPopup>
            </div>
        </div>
        <div
            ref="content"
            class="tabs-content"
            :class="[animated ? 'tabs-content--animated' : '',type === 'icon' ? 'tabs-cardContent' : '']"
            :style="{ minHeight:fillScreen ? minHeight : null }"
            v-on="listeners"
        >
            <div
                v-if="animated"
                class="tabs-content--animated--wrap"
                :style="contentStyle"
            >
                <!-- slot放置pane组件内容 -->
                <slot></slot>
            </div>
            <!-- slot放置pane组件内容 -->
            <slot v-else></slot>
        </div>
    </div>
</template>

<script>
    import {
        on, off,
    } from '@wanwu/event-utils';
    import mixinTouch from '@wanwu/base-vue-mixin-touch';
    import mixinProps from './mixins/props';
    import AllPopup from './AllPopup';
    import {
        getVisibleHeight,
        getElementTop,
        setRootScrollTop,
        scrollLeftTo,
        scrollTopTo,
        getVisibleBottom,
        getVisibleTop,
    } from './utils/dom';
    export default {
        name: 'Tabs',
        components: {
            AllPopup,
        },
        mixins: [
            mixinTouch,
            mixinProps,
        ],
        data() {
            return {
                currentValue: this.value,
                navList: [],
                lineStyle: {},
                events: {},
                barStyle: {},
                navObj: {},
                minHeight: null,
                allPopupShow: false,
                popupTop: 0,
                barHeight: 0,
                scrollLeftRafId: 0,
                scrollTopRafId: 0,
                lineTimer: null,
                clikTimer: null,
            };
        },

        computed: {
            showAllBgStyle() {
                if (this.showAllStyle && this.showAllStyle.bgColor) {
                    const bgColor = this.showAllStyle.bgColor;
                    if (bgColor instanceof Array) {
                        return `background: linear-gradient(to left, ${bgColor[0]} 80%, ${bgColor[1]})`;
                    } else {
                        return `background: linear-gradient(to left, ${bgColor} 80%, transparent)`;
                    }
                }
                return '';
            },
            containerStyle() {
                const style = {};
                if ((this.fixed || this.barStyle.position === 'fixed' || this.barStyle.position === 'absolute') && !(typeof this.hiddenBar === 'boolean')) {
                    style.paddingTop = (this.tabHeight / 100 * window.computedRem || this.barHeight) + 'px';
                }
                return style;
            },
            fixedStyle() {
                if (this.fixed) {
                    return {
                        width: '100%',
                        position: 'fixed',
                        top: this.offsetTopPx + 'px',
                        zIndex: 1000,
                    };
                }
                return {};
            },
            scrollable() {
                return this.navList.length > this.swipeThreshold;
            },
            tabStyle() {
                const style = {};
                if (this.scrollable && !this.tabAutoWidth) {
                    style.flexBasis = `${88 / this.swipeThreshold}%`;
                }
                if (this.tabAutoWidth) {
                    style.flex = '0';
                }
                return style;
            },
            listeners() {
                if (this.swipeable) {
                    return {
                        touchstart: this.touchStart,
                        touchmove: this.onTouchMove,
                        touchend: this.onTouchEnd,
                        touchcancel: this.onTouchEnd,
                    };
                }
                return {};
            },
            contentStyle() {
                if (this.animated) {
                    return {
                        left: `${-1 * this.navObj[this.currentValue] * 100}%`,
                        // transform: `translate3d(${-1 * this.navObj[this.currentValue] * 100}%, 0, 0)`,
                        transitionDuration: `${this.duration}s`,
                    };
                }
                return {};
            },
            currentIndex() {
                return this.navObj[this.currentValue];
            },
            offsetTopPx() {
                return this.top * window.computedRem || ((window.appHeaderHeight || 0) + (this.offsetTop || 0) / 100) * window.computedRem;
            },
            scrollOffset() {
                return this.offsetTopPx + this.barHeight;
            },
        },
        watch: {
            value(val) {
                this.currentValue = val;
            },
            currentValue(name) {
                this.updateStatus();
                this.scrollIntoView();
                this.setLine();
                this.getMinHeight();
                this.changeScroll();
                this.$emit('input', name);
                this.$emit('change', name);
            },
            navList() {
                this.setLine();
                this.$nextTick(() => {
                    this.scrollIntoView(true);
                });
            },
        },
        mounted() {
            this.onShow();
        },
        activated() {
            this.onShow();
            this.setLine();
        },
        deactivated() {
            this.handlers(false);
            this.clearComponentTimer();
        },
        beforeDestroy() {
            this.handlers(false);
            this.clearComponentTimer();
        },
        methods: {
            async setCurrentValue(newValue) {
                if (newValue === this.currentValue) {
                    return false;
                }

                if (this.beforeChange && typeof this.beforeChange === 'function') {
                    let result;

                    try {
                        result = await this.beforeChange(newValue, this.currentValue);
                    } catch (e) {
                        result = false;
                    }

                    if (result === false) {
                        return false;
                    }
                }

                this.currentValue = newValue;
                return true;
            },
            async swipeToNextTab(step) {
                if (step === 0) {
                    return;
                }

                let currentIndex = this.navObj[this.currentValue];

                currentIndex += step;
                while (currentIndex >= 0 && currentIndex <= this.navList.length - 1) {
                    const changeResult = await this.setCurrentValue(this.navList[currentIndex].name);

                    if (changeResult) {
                        break;
                    }

                    currentIndex += step;
                }
            },
            clearComponentTimer() {
                if (this.lineTimer) {
                    clearTimeout(this.lineTimer);
                    this.lineTimer = null;
                }
                if (this.clikTimer) {
                    clearTimeout(this.clikTimer);
                    this.clikTimer = null;
                }
            },
            // 滚动到选中模块的顶部
            changeScroll() {
                if (!this.scrollspy && this.barStyle.position === 'fixed' && this.scrollToTopOnChange) {
                    // + 1 为了防止fixed状态消失，当 containerTop = this.offsetTopPx 时
                    setRootScrollTop(Math.ceil(getElementTop(this.$el) - this.offsetTopPx) + 1);
                }
            },
            scrollToCurrentContent(index, isCheck) {
                const {
                    content,
                } = this.$refs;
                if (this.scrollspy && content) {
                    const target = content.childNodes[this.currentIndex];
                    if (target) {
                        const to = Math.ceil(getElementTop(target) - this.scrollOffset) + 1;
                        this.lockScroll = true;
                        let duration = this.duration;
                        if (isCheck || !this.scrollspyAnimate) {
                            duration = 0;
                        }
                        this.scrollTopRafId = scrollTopTo(to, duration, () => {
                            if (isCheck) {
                                this.lockScroll = false;
                            } else {
                                this.checkIndex(index);
                            }
                        }, this.scrollTopRafId);
                    }
                }
            },

            // 检查滚动动画完成后定位的index
            checkIndex(index) {
                const current = this.getCurrentIndexOnScroll();
                if (current !== index) {
                    this.scrollToCurrentContent(index, true);
                } else {
                    this.lockScroll = false;
                }
            },

            getCurrentIndexOnScroll() {
                const {
                    content, bar,
                } = this.$refs;

                if (!content || !bar) return;

                const children = content.childNodes;

                for (let index = 0; index < children.length; index++) {
                    if (getVisibleTop(children[index]) > this.scrollOffset) {
                        return index === 0 ? 0 : index - 1;
                    }
                }

                return children.length - 1;
            },
            getTabs() {
                // 获取pane
                return this.$children.filter(function (item) {
                    return item.$options.name === 'TabsPane';
                });
            },
            updateNav() {
                // 获取标题，name,并放置到navList数组中
                const list = [];
                this.navObj = {};
                const _this = this;
                this.getTabs().forEach(function (pane, index) {
                    list.push({
                        label: pane.label,
                        name: pane.name || index,
                        iconImage: pane.iconImage || '',
                        iconFont: pane.iconFont || '',
                        isClick: pane.isClick,
                    });
                    _this.navObj[pane.name || index] = index;

                    if (!pane.name) pane.name = index;
                    if (index === 0) {
                        if (!_this.currentValue) {
                            _this.currentValue = pane.name || index;
                        // _this.currentIndex = index;
                        }
                    }
                });
                this.navList = list;
                this.updateStatus();
            },
            updateStatus() {
                const tabs = this.getTabs();
                const _this = this;
                tabs.forEach(function (tab) {
                    if (_this.animated || _this.scrollspy) {
                        tab.show = true;
                    } else {
                        const b = tab.name === _this.currentValue;
                        tab.show = b;
                    }
                // return tab.show;
                });
            },
            // update nav bar style
            // retryCnt 重试次数
            setLine(retryCnt = 0) {
                if (this.type === 'card' || this.type === 'icon') {
                    return;
                }

                const shouldAnimate = this.shouldAnimate;

                this.$nextTick(() => {
                    const {
                        tabs, line,
                    } = this.$refs;

                    if (!tabs || !tabs[this.navObj[this.currentValue]]) {
                        return;
                    }

                    const tab = tabs[this.navObj[this.currentValue]];
                    const tabContent = tab.getElementsByClassName('tabs-label--content')[0];
                    let width = tab.offsetWidth / 2;
                    if (line) {
                        width = line.offsetWidth;
                    } else if (tabContent) {
                        width = tabContent.offsetWidth;
                    }
                    const left = tab.offsetLeft + (tab.offsetWidth - width) / 2;

                    // 解决安卓客户端 webview 没有宽度时渲染页面导致下划线定位不准确问题（重试一次）
                    if (!document.body.offsetWidth && retryCnt < 1) {
                        this.lineTimer = setTimeout(() => {
                            retryCnt++;
                            this.setLine(retryCnt);
                        }, 100);
                        return;
                    }
                    const lineStyle = {
                        width: width + 'px',
                        transform: `translateX(${left}px)`,
                    };

                    if (shouldAnimate) {
                        lineStyle.transitionDuration = `${this.duration}s`;
                    }

                    this.lineStyle = lineStyle;
                });
            },
            handleClick(index) {
                const nav = this.navList[index];
                if (nav.isClick) {
                    const name = nav.name;
                    this.$emit('click', name);
                    if (name !== this.currentValue) {
                        if (this.delay) {
                            this.clikTimer = setTimeout(() => {
                                // this.currentValue = name;
                                this.setCurrentValue(name).then(changeResult => {
                                    changeResult && this.scrollToCurrentContent(index);
                                });
                            }, 300);
                        } else {
                            // this.currentValue = name;
                            this.setCurrentValue(name).then(changeResult => {
                                changeResult && this.scrollToCurrentContent(index);
                            });
                        }
                    }
                }
            },
            getMinHeight() {
                if (!this.fillScreen) return;
                const {
                    bar,
                } = this.$refs;
                const screenHeight = window.screen.availHeight;
                this.minHeight = (screenHeight - getVisibleBottom(bar) + 1) + 'px';
            },
            handlers(bind) {
                const {
                    events,
                } = this;
                if (events.resize !== bind) {
                    events.resize = bind;
                    (bind ? on : off)(window, 'resize', this.setLine, true);
                }
                if (this.sticky || this.scrollspy) {
                    if (events.scroll !== bind) {
                        events.scroll = bind;
                        (bind ? on : off)(window, 'scroll', this.onScoll, true);
                    }
                }
            },
            onScoll() {
                if (this.scrollspy && !this.lockScroll) {
                    const currentIndex = this.getCurrentIndexOnScroll();
                    this.currentValue = this.navList[currentIndex].name;
                }
                const {
                    container,
                } = this.$refs;
                if (!this.sticky || !container) return;

                // 吸顶时距离页面顶部高度
                const containerBottom = getVisibleBottom(container);
                const containerTop = getVisibleTop(container);
                const condition = this.isStickyAlways ? containerTop < this.offsetTopPx : containerTop < this.offsetTopPx && containerBottom > this.offsetTopPx;
                if (condition) {
                    const barStyle = {
                        position: 'fixed',
                        top: this.offsetTopPx + 'px',
                    };
                    if (this.tabbarAnimate) {
                        const transform = -(this.barHeight - (containerBottom - this.offsetTopPx));
                        if (transform < 0 && !this.isStickyAlways) {
                            barStyle.transform = `translate3d(0, ${transform}px, 0)`;
                        }
                    }
                    this.barStyle = barStyle;
                    this.$emit('onFixed', true);
                } else {
                    this.barStyle = {};
                    this.$emit('onFixed', false);
                }
            },
            onShow() {
                this.handlers(true);
                this.$nextTick(() => {
                    this.barHeight = getVisibleHeight(this.$refs.bar);
                    this.scrollIntoView(true);
                });
            },
            renderTitle(el, index) {
                this.$nextTick(() => {
                    const tab = this.$refs.tabs[index];
                    tab.parentNode.replaceChild(el, tab);
                    this.$refs.tabs[index] = el;
                });
            },
            // scroll active tab into view
            scrollIntoView(immediate) {
                const {
                    tabWraps,
                } = this.$refs;

                if (!this.scrollable || !tabWraps || !tabWraps[this.navObj[this.currentValue]]) {
                    return;
                }

                const {
                    barbody,
                } = this.$refs;
                const tab = tabWraps[this.navObj[this.currentValue]];
                const to = tab.offsetLeft - (barbody.offsetWidth - tab.offsetWidth) / 2;
                this.scrollLeftRafId = scrollLeftTo(barbody, to, immediate ? 0 : +this.duration, this.scrollLeftRafId);
            },

            onTouchMove(event) {
                if (!this.swipeable) return;

                this.touchMove(event);

                if (this.direction === 'horizontal') {
                    event.preventDefault();
                    event.stopPropagation();
                }
            },
            onTouchEnd() {
                const {
                    deltaX, currentValue,
                } = this;
                const currentIndex = this.navObj[currentValue];

                if (this.direction === 'horizontal') {
                    if (deltaX > 0 && currentIndex !== 0) {
                        this.swipeToNextTab(-1);
                        // this.currentValue = this.navList[currentIndex - 1].name;
                    } else if (deltaX < 0 && currentIndex !== this.navList.length - 1) {
                        this.swipeToNextTab(1);
                        // this.currentValue = this.navList[currentIndex + 1].name;
                    }
                }
            },
            showAllClick() {
                const {
                    bar,
                } = this.$refs;
                this.popupTop = getVisibleTop(bar);
                this.allPopupShow = !this.allPopupShow;
            },
            allTabsChange({
                item, index,
            }) {
                // this.currentValue = item.name;
                this.setCurrentValue(item.name).then(changeResult => {
                    if (changeResult) {
                        this.scrollToCurrentContent();
                        this.allPopupShow = false;
                    }
                });
            },
        },
    };
</script>

<style lang='less' scoped>
.component__tabs {
    &.tabs-relative {
        position: relative;
    }

    .tabs-bar {
        display: flex;
        position: relative;
        width: 100%;
        background: rgba(255, 255, 255, 1);
        border-bottom: 2px solid #f8f8f8;
        z-index: 1000;
        box-sizing: border-box;

        .tabs-tab-wrap {
            position: relative;
            overflow-x: auto;
            display: flex;
            height: 100%;
            width: 100%;

            &::-webkit-scrollbar {
                display: none;
            }
        }

        &--line-position {
            z-index: 1000;
            left: 0;
            bottom: 0;
            position: absolute;
            will-change: transform;
            color: #cf142b;
        }

        &--line {
            height: 4px;
            border-radius: 3px;
            background-color: #ea3131;
        }

        .line__slot {
            height: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0.25);
            transform-origin: center bottom;
            margin-bottom: 10px;

            .ww-icon-xuanzhong {
                font-size: 24px;
            }
        }
    }

    .will_hiddenBar {
        position: fixed;
    }

    .hiddenBar {
        opacity: 0;
        pointer-events: none;
    }

    .tabs-bar-showall {
        position: static;
    }

    .tabs-tab {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        font-size: 26px;
        font-weight: 400;
        color: rgba(155, 155, 155, 1);
        line-height: 80px;

        .tabs-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            white-space: nowrap;
            overflow: hidden;
        }
    }

    .split-line {
        position: relative;

        &:not(:last-child)::after {
            content: ' ';
            width: 2px;
            height: 24px;
            background: rgba(234, 234, 235, 1);
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
    }

    .showAllOccupying {
        width: 84px;
        height: 88px;
        flex-shrink: 0;
    }

    .scrollable {
        .tabs-tab {
            flex: 0 0 22%;
        }
    }

    .tab-autoWidth {
        padding: 0 10px;

        .tabs-tab {
            padding: 0 8px;

            .tabs-label {
                padding: 0 10px;
            }
        }
    }

    .tabs-tab-active {
        font-weight: 600;
        color: rgba(234, 49, 49, 1);
    }

    .tabs-cardContent {
        padding: 0;
    }

    .tabs-content--animated {
        width: 100%;
        overflow: hidden;

        .tabs-content--animated--wrap {
            display: flex;
            will-change: left;
            position: relative;
        }

        .tabsPane {
            width: 100%;
            flex-shrink: 0;
        }
    }

    .arrow__wrap {
        position: absolute;
        width: 84px;
        height: 88px;
        right: 0;

        &--click {
            position: relative;
            top: 0;
            right: 0;
            z-index: 1000;
            height: 100%;
        }
    }

    .arrow__bg {
        width: 100%;
        height: 100%;
        background: linear-gradient(to left, rgba(255, 255, 255, 1) 80%, rgba(255, 255, 255, 0));
        position: absolute;
        z-index: 1000;
        top: 0;
        right: 0;
    }

    .arrow__icon {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        right: 0;
        z-index: 1000;

        i {
            font-size: 48px;
            transition: all 0.3s;
        }
    }

    &.tabs-new {
        > .tabs-bar {
            .tabs-tab {
                font-size: 32px;
                color: rgba(99, 102, 108, 1);
                line-height: 88px;
            }

            .tabs-tab-active {
                color: rgba(207, 20, 43, 1);
            }

            &--line {
                background-color: rgba(207, 20, 43, 1);
            }
        }
    }

    &.tabs-card {
        > .tabs-bar {
            padding: 16px 0;
            background-color: transparent;
            border-bottom: 0;

            &::after {
                content: " ";
                width: 1px;
                height: 1px;
                flex-shrink: 0;
            }

            .tabs-tab {
                font-size: 26px;
                height: 64px;
                background-color: #fff;
                border-radius: 4px;
                padding: 0 28px;
                margin-right: 18px;
                line-height: 64px;

                .tabs-label {
                    padding: 0;
                }
            }

            .tabs-tab:first-child {
                margin-left: 28px;
            }

            .tabs-tab:last-child {
                margin-right: 28px;
            }

            .tabs-tab-active {
                background-color: #fbe9eb;
                color: #cf142b;
                border: 1px solid rgba(241, 190, 197, 1);
            }
        }
    }

    &.tabs-icon {
        > .tabs-bar {
            .tabs-tab-wrap {
                border-bottom: 0;
                height: 96px;
                line-height: inherit;

                .tabs-tab {
                    line-height: inherit;
                    .tabs-label {
                        display: inline-flex;
                        line-height: inherit;

                        .icon__wrap {
                            width: 34px;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            margin-right: 6px;
                            box-sizing: content-box;
                            opacity: 0;
                            transform-origin: left bottom;

                            > img {
                                width: 100%;
                                height: 100%;
                                display: block;
                            }
                        }

                        .label {
                            transform: translateX(-20px);
                            transition: all 0.4s;
                        }
                    }
                }

                .tabs-tab-active {
                    .tabs-label {
                        .icon__wrap {
                            opacity: 1;
                            transform: scale(1);
                            animation: iconMove 0.6s;
                        }

                        .label {
                            transform: translateX(0);
                        }
                    }
                }

                @keyframes iconMove {
                    0% {
                        opacity: 0;
                        transform: scale(0) rotate(0);
                    }
                    25% {
                        opacity: 1;
                        transform: scale(1) rotate(0);
                    }
                    50% {
                        opacity: 1;
                        transform: scale(1) rotate(-15deg);
                    }
                    100% {
                        opacity: 1;
                        transform: scale(1) rotate(0);
                    }
                }
            }
        }
    }
}
</style>
