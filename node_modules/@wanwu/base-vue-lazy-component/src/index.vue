<template>
    <keep-alive :max="5">
        <div
            v-if="show"
            class="component__lazyComponent lazyComponent"
        >
            <slot></slot>
        </div>

        <div
            v-else-if="$slots.skeleton"
            class="component__lazyComponent lazyComponent"
        >
            <slot name="skeleton"></slot>
        </div>
        <div
            v-else
            class="component__lazyComponent lazyComponent"
            :class="perchClass"
            :style="realStyle || perchStyle"
        ></div>
    </keep-alive>
</template>

<script>
    import {
        onListenScroll, logExposureAll, addListerner, cacheShowScope,
    } from './listen';
    import {
        ua,
    } from '@wanwu/base-fn';

    export default {
        name: 'LazyComponent',
        components: {},
        props: {
            preLoad: {
                type: Number,
                // default: ua.isIOSApp() ? 6 : 2,
                // ios webview更换后不存在性能限制问题了，去除对ios的特殊处理
                default: 2,
            },
            height: {
                type: [
                    Number,
                ],
                default: () => 500,
            },
            width: {
                type: [
                    Number,
                ],
            },
            perchClass: {
                type: [
                    String,
                    Object,
                ],
            },
            type: {
                type: [
                    Number,
                    String,
                ],
                default: 0,
            },
            noRecycle: {
                type: Boolean,
            },
            // 当前曝光数据
            exposureData: {
                type: Object,
            },
            // 新的曝光数据
            newExposureData: {
                type: Object,
            },
            // 筛选器文案
            filterTexts: {
                type: Array,
                default: () => [
                    '全部',
                ],
            },
        },
        data() {
            return {
                el: null,
                state: {
                    loaded: false,
                    isInRealView: false,
                },
                rect: {},
                show: false,
                realStyle: null,
                showScopeCache: null,
            };
        },

        computed: {
            perchStyle() {
                return {
                    height: this.height ? this.height / 100 + 'rem' : null,
                    width: this.width ? this.width / 100 + 'rem' : null,
                };
            },
        },
        mounted() {
            // if (ua.isIOSApp()) {
            //     this.show = true;
            //     return;
            // }
            this.el = this.$el;
            addListerner(this);
            onListenScroll(this);
        },
        activated() {
            if (!ua.isIOS()) {
                addListerner(this);
            } else {
                setTimeout(() => {
                    addListerner(this);
                }, 500);
            }
        },
        beforeDestroy() {
            // if (ua.isIOSApp()) {
            //     return;
            // }
            // ArrayRemove(dataObj[this.type].listenList, this);
            this.showScopeCache = cacheShowScope(this.type);
            logExposureAll();
        },
        deactivated() {
            // if (ua.isIOSApp()) {
            //     return;
            // }
            // ArrayRemove(dataObj[this.type].listenList, this);
            this.showScopeCache = cacheShowScope(this.type);
            logExposureAll();
        },
        created() {
            // listenList.push(this);
            // // isCanShow();
            // onListenScroll(this.viewport);
        },
        methods: {
            getRect() {
                this.rect = this.$el.getBoundingClientRect();
            },
            checkInView() {
                return this.checkInWindow(this.preLoad);
            },
            checkInRealView() {
                return this.checkInWindow(1);
            },
            checkInWindow(preLoad) {
                return typeof window !== 'undefined' &&
                    (this.rect.top <= window.innerHeight * preLoad && this.rect.bottom >= -window.innerHeight * (preLoad - 1)) &&
                    (this.rect.left <= window.innerWidth * preLoad && this.rect.right >= -window.innerWidth * (preLoad - 1));
            },
            setState(state) {
                if (state) {
                    Object.keys(state).forEach(key => {
                        this.$set(this.state, key, state[key]);
                    });
                }
            },
            load() {
                this.show = true;
                // this.state.loaded = true;
                this.setState({
                    loaded: true,
                });
                this.$emit('show', this);
            },
            recycle() {
                this.getRect();
                this.realStyle = {};
                const height = this.rect.height > window.innerHeight ? window.innerHeight : this.rect.height;
                const width = this.rect.width > window.innerWidth ? window.innerWidth : this.rect.width;
                this.realStyle.height = height + 'px';
                this.realStyle.width = width + 'px';
                this.show = false;
                this.setState({
                    loaded: false,
                });
                this.$emit('recycle', this);
            },
        },
    };
</script>

