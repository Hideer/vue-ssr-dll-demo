<!--
 * @Descripttion:
 * @version:
 * @Author: taoyeah
 * @Date: 2021-06-21 17:52:06
 * @LastEditors: taoyeah
 * @LastEditTime: 2021-09-14 18:20:28
-->
<template>
    <img
        v-if="lazyLoad && hasSetSize"
        ref="__imgCompontent__"
        v-lazy:[{width:(cutWidth||width),height:(cutHeight||height)}]="imageSrc"
        class="component__UnifyImage"
        :alt="alt"
        :style="imgStyle"
        @click="imgClick"
    />
    <img
        v-else-if="lazyLoad && !hasSetSize"
        ref="__imgCompontent__"
        v-lazy="imageSrc"
        class="component__UnifyImage"
        :alt="alt"
        :style="imgStyle"
        @click="imgClick"
    />
    <img
        v-else-if="!lazyLoad"
        ref="__imgCompontent__"
        :src="imageSrc"
        class="component__UnifyImage"
        :alt="alt"
        :style="imgStyle"
        @click="imgClick"
    />
</template>

<script>
    import { getLazyFn } from '@wanwu/base-vue-directive-lazy';
    import numToRem from '@wanwu/base-vue-filters-num-to-rem';
    const lazy = getLazyFn({
        loading:
            'https://cdn.wanwudezhi.com/seller-admin/image/MTU1NDk2MjkxNzI2Nw==.png',
        error: 'https://cdn.wanwudezhi.com/seller-admin/image/MTU1NDk2Mjk3MzczMw==.png',
    });
    export default {
        name: 'FImage',
        directives: {
            lazy,
        },
        props: {
            // 图片裁剪尺寸宽度
            cutWidth: {
                type: [Number, String],
                default: 0,
                validator: (val) => !isNaN(Number(val)),
            },
            // 图片裁剪尺寸高度
            cutHeight: {
                type: [Number, String],
                default: 0,
                validator: (val) => !isNaN(Number(val)),
            },
            // 图片裁剪尺寸宽度
            width: {
                type: [Number, String],
                default: '',
                validator: (val) => !isNaN(Number(val)),
            },
            // 图片裁剪尺寸高度
            height: {
                type: [Number, String],
                default: '',
                validator: (val) => !isNaN(Number(val)),
            },
            // 图片地址
            src: {
                type: String,
                default: '',
            },
            // 图片描述文本
            alt: {
                type: String,
                default: '',
            },
            // 图片格式
            format: {
                type: String,
                default: '',
            },
            // 水印（使用水印后图片的基础处理imageView2无效）
            watermarkString: {
                type: String,
                default: '',
            },
            // 是否支持渐进显示 取值范围：1 支持渐进显示，0不支持渐进显示(默认为0) 适用jpg目标格式
            interlace: {
                type: Number,
                default: 1,
            },
            // 生成图片的质量：1-100，适用jpg目标格式
            quality: {
                type: Number,
                default: 75,
            },
            // 是否开启懒加载
            lazyLoad: {
                type: Boolean,
                default: true,
            },
        },
        data() {
            return {
                isSupportWebP: false,
                baseWidth: 375, // 默认基础屏幕尺寸
                styleWidth: 0,
                styleHeight: 0,
                remRatio: 1,
                cdnUrlPattern: /^http(s?):\/\/cdn\.wanwudezhi\.com/,
            };
        },
        computed: {
            Dpr() {
                const DPR = Math.max(2, window.devicePixelRatio);
                return DPR ? Math.ceil(DPR) : 3;
            },
            imageSrc() {
                if (this.getImageUrl) {
                    if (this.watermarkString) {
                        const originUrl = this.getOriginImage(this.getImageUrl);
                        return `${originUrl}?${this.watermarkString}`;
                    }
                    return this.getImageUrl;
                } else {
                    return '';
                }
            },
            imgStyle() {
                return {
                    width: numToRem(this.width),
                    height: numToRem(this.height),
                };
            },
            // 尺寸处理
            getSize() {
                // 若使用用户传入的尺寸，先转换为1倍，然后根据baseWidth确定是以414为标准还是375位标准；
                const _width = (this.cutWidth || this.width) / 2 * (this.baseWidth / 375);
                const _height = (this.cutHeight || this.height) / 2 * (this.baseWidth / 375);

                // 若通过style中读取，用读取值乘以remRatio的倒数进行处理，保证和用户传入的数据保持一致；
                const _styleWidth = this.styleWidth * (1 / this.remRatio);
                const _styleHeight = this.styleHeight * (1 / this.remRatio);

                // 以用户传入的width和height作为最高准则，若没有则兼容style的尺寸；
                return {
                    width: Math.ceil((_width || _styleWidth) * this.Dpr),
                    height: Math.ceil((_height || _styleHeight) * this.Dpr),
                };
            },
            getImageUrl() {
                // 通过判断避免加载两次图片
                const noSize = !this.cutWidth && !this.cutHeight &&
                    !this.height && !this.width &&
                    !this.styleWidth && !this.styleHeight;
                if (noSize || !this.src) return;

                // const width = parseInt(((this.cutWidth / 2 * this.remRatio) || this.styleWidth) * this.Dpr);
                // const height = parseInt(((this.cutHeight / 2 * this.remRatio) || this.styleHeight) * this.Dpr);
                const cutWidth = this.getSize.width;
                const cutHeight = this.getSize.height;

                const suffix = this.src.replace(/^.*\.(\w+)$/, '$1');

                let format = 'webp';
                // 处理ios新版手机的新的图片格式的问题
                if (suffix.toUpperCase() === 'HEIC' || suffix.toUpperCase() === 'HEIF') {
                    format = 'jpg';
                } else {
                    if (this.format === 'webp' || !this.format) {
                        format = this.isSupportWebP ? 'webp' : (suffix || 'jpg');
                    } else {
                        format = this.format;
                    }
                }
                let imageQuery = '';

                // // 减少不同尺寸的图片的格式；以50为间隔进行处理
                // cutWidth = Math.ceil(cutWidth / 50) * 50;
                // cutHeight = Math.ceil(cutHeight / 50) * 50;

                // 之前处理过的图片 或 base64的 不在处理
                // const originUrl = this.getOriginImage(this.src);
                const base64Reg = /^data:image\/\w+;base64,.+$/;
                if (this.src.includes('imageView2') || base64Reg.test(this.src)) {
                    return this.src;
                }
                if (cutWidth && cutHeight) {
                    imageQuery = `imageView2/1/w/${cutWidth}/h/${cutHeight}/format/${format}`;
                } else if (cutWidth) {
                    imageQuery = `imageView2/2/w/${cutWidth}/format/${format}`;
                } else if (cutHeight) {
                    imageQuery = `imageView2/2/h/${cutHeight}/format/${format}`;
                }

                // 渐进显示和图片质量控制
                if (suffix === 'jpg') {
                    imageQuery = `${imageQuery}/interlace/${this.interlace}/q/${this.quality}`;
                } else {
                    // console.warn('图片渐进显示、质量控制只支持jpg图片格式！');
                }

                // if (!this.styleWidth && !this.styleHeight) return null;

                return `${this.src}?${imageQuery}`;
            },
            hasSetSize() {
                return (this.cutWidth && this.cutHeight) || (this.width && this.height);
            },
        },
        created() {
            // 避免同一个页面过多使用querySelector影响性能，通过挂载window的方式减少querySelector访问；
            if (window.__remRatio__) {
                this.remRatio = window.__remRatio__;
            } else {
                // 最大的remRatio限制为2；
                this.remRatio = Math.min(window.innerWidth, 750) / this.baseWidth || 1;
                window.__remRatio__ = this.remRatio;
            }
            // 判断浏览器是否支持webp格式(缓存挂载window上)
            if (window.__supportWebP__) {
                this.isSupportWebP = window.__supportWebP__;
            } else {
                try {
                    this.isSupportWebP = (document.createElement('canvas').toDataURL('image/webp').indexOf('data:image/webp') === 0);
                } catch (err) {
                    this.isSupportWebP = false;
                }
                window.__supportWebP__ = this.isSupportWebP;
            }
        },
        mounted() {
            (!this.cutWidth && !this.cutHeight && !this.width && !this.height) && this.getStyle();
        },
        methods: {
            getStyle() {
                // this.$nextTick(() => {
                const ele = this.$refs.__imgCompontent__;
                const { width = 0, height = 0 } = window.getComputedStyle(ele);
                this.styleWidth = Number(parseFloat(width).toFixed(2));
                this.styleHeight = Number(parseFloat(height).toFixed(2));
                if (!this.styleWidth && !this.styleHeight) console.error('获取图片尺寸失败！！');
                // });
            },
            checkIsCdnUrl(url) {
                return this.cdnUrlPattern.test(url);
            },
            getOriginImage(url) {
                if (!this.checkIsCdnUrl(url)) {
                    return url;
                }
                return (url && url.split('?')[0]) || '';
            },
            imgClick() {
                // 点击图片的回调
                this.$emit('click', this.imageSrc);
            },
        },
    };
</script>

<style lang="less" scoped>
.component__UnifyImage {
}
</style>
